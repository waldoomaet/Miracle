@page "/"
@inject ToShare ToShare
@inject NavigationManager NavigationManager


<h1>¡Bienvenido a PedidosYa!</h1>
<h4>Selecciona el restaurante de tu preferencia: </h4>
<input type="text" placeholder="¡Busca aqui!" @bind="@input"/>
<button @onclick="FindRestaurant">Buscar</button>

@if(order != null)
{
    <p>Bill: @order.Bill</p>
    for(int index = 0; index < order.Ordered.Count; index++)
    {
        int i = index;
        Meal meal = order.Ordered[i];
        <label for=@($"meal{i}")>@meal.Name - @meal.Description - $@meal.Price</label>
        <button id=@($"meal{i}") @onclick="() => order.Remove(meal)">Remover</button>
        <br />
    }
}

@if (restaurantFound)
{
    <p>@currentRestaurant.Name</p>
    <p>Puntuacion: @currentRestaurant.Rate</p>
    for(int i = 0; i < currentRestaurant.Menu.Count; i++)
    {
        Meal meal = currentRestaurant.Menu[i];
        <button @onclick="() => ChooseAmount(meal)">@meal.Name - @meal.Description - $@meal.Price</button>
        <br />
    }
}

@if (restaurantNotFound)
{
    <p>Resturante no encontrado...</p>
}

@if (mealAmount)
{
    <input type="number" min="1" @bind="@amount"/>
    <button @onclick="AddToOrder">Seleccionar</button>
}

@if(order != null)
{
    <br />
    <button @onclick="ToMap">¡Ordenar!</button>
}

@code{
    private string input = "";
    private int amount = 1;
    private List<Restaurant> restaurants =  new List<Restaurant>();
    private bool restaurantFound = false;
    private bool restaurantNotFound = false;
    private bool mealAmount = false;
    private Restaurant currentRestaurant;
    private Meal currentMeal;
    private Order order;

    protected override void OnInitialized()
    {
        // All this has to come from db
        List<Meal> menu = new List<Meal>()
        {
            new Meal("Baconator", "Delicious burguer with lots of bacon", 10.0),
            new Meal("3/4 punds", "Big burguer for those with big apettite", 12.0),
            new Meal("Buffalo wings", "Tasty BBQ bathed buffalo wings", 6.0)
        };
        restaurants.Add(new Restaurant("Wendy's", 18.463870, -69.960820, 4.8, menu));
    }

    private void ChooseAmount(Meal meal)
    {
        mealAmount = true;
        currentMeal = meal;
    }

    private void AddToOrder()
    {
        if(order == null) order = new Order(currentRestaurant);
        for (; amount > 0; amount--) order.Add(currentMeal);
        amount = 1;
        mealAmount = false;
    }

    private void FindRestaurant()
    {
        currentRestaurant = null;
        currentMeal = null;
        order = null;
        restaurantFound = false;
        restaurantNotFound = false;
        currentRestaurant = restaurants.Find(restaurant => restaurant.Name.ToLower().Contains(input.ToLower()));
        if (currentRestaurant != null) restaurantFound = true;
        else restaurantNotFound = true;
    }

    private void ToMap()
    {
        ToShare.Order = order;
        NavigationManager.NavigateTo("/map");
    }
}